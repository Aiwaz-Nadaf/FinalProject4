{% extends "admin_base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2>View Users</h2>
            <p class="text-muted">Users Who Accepted Donation Requests</p>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Users Who Accepted Donation Requests</h5>
            <div class="input-group w-auto">
                <input type="text" class="form-control" id="searchInput" placeholder="Search users...">
                <button class="btn btn-outline-light" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Blood Group</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Address</th>
                            <th>Blood Group Needed</th>
                            <th>Request Date</th>
                            <th>Response Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in users_with_forms %}
                        <tr>
                            <td>{{ item.user.name }}</td>
                            <td>
                                <span class="badge bg-danger">{{ item.user.blood_group }}</span>
                            </td>
                            <td>{{ item.user.phone }}</td>
                            <td>{{ item.user.email }}</td>
                            <td>{{ item.user.location.address if item.user.location else 'N/A' }}</td>
                            <td>
                                <span class="badge bg-danger">{{ item.request.data.blood_group_needed if item.request.data else 'N/A' }}</span>
                            </td>
                            <td>{{ item.request.created_at.strftime('%Y-%m-%d %H:%M:%S') if item.request.created_at else 'N/A' }}</td>
                            <td>{{ item.request.response_time.strftime('%Y-%m-%d %H:%M:%S') if item.request.response_time else 'N/A' }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewUserDetails('{{ item.user._id }}', {{ item.blood_forms|length }})">
                                    <i class="fas fa-eye"></i> VIEW DETAILS
                                </button>
                                <button class="btn btn-sm btn-success" onclick="sendMessage('{{ item.user._id }}')">
                                    <i class="fas fa-comment"></i> MESSAGE
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="userDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="openDonationFormBtn" class="btn btn-danger">
                    <i class="fas fa-file-medical"></i> Donation Form
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentFirstFormId = null;
function viewUserDetails(userId, formCount) {
    console.log('viewUserDetails called with userId:', userId, 'formCount:', formCount);
    
    // Fetch user details including blood donation forms
    fetch(`/admin/user/${userId}`)
        .then(response => response.json())
        .then(data => {
            console.log('User data received:', data);
            if (data.success) {
                const user = data.user;
                const bloodForms = data.blood_forms || [];
                currentFirstFormId = bloodForms.length > 0 ? (bloodForms[0].form_id || null) : null;
                
                let userDetailsHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Personal Information</h6>
                            <p><strong>Name:</strong> ${user.name || 'N/A'}</p>
                            <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${user.phone || 'N/A'}</p>
                            <p><strong>Blood Group:</strong> <span class="badge bg-danger">${user.blood_group || 'N/A'}</span></p>
                            <p><strong>Address:</strong> ${user.location?.address || 'N/A'}</p>
                            <p><strong>City:</strong> ${user.location?.city || 'N/A'}</p>
                            <p><strong>State:</strong> ${user.location?.state || 'N/A'}</p>
                            <p><strong>Pincode:</strong> ${user.location?.pincode || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Donation History</h6>
                            <p><strong>Last Donation:</strong> ${user.last_donation_date || 'Never'}</p>
                            <p><strong>Total Donations:</strong> ${user.total_donations || 0}</p>
                            <p><strong>Last Notification:</strong> ${user.last_notification || 'Never'}</p>
                            <p><strong>Account Created:</strong> ${user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A'}</p>
                            <h6 class="text-primary mt-3">Health Data</h6>
                            <p><strong>Weight:</strong> ${user.weight || 'N/A'} kg</p>
                            <p><strong>Height:</strong> ${user.height || 'N/A'} cm</p>
                            <p><strong>Blood Pressure:</strong> ${user.blood_pressure || 'N/A'}</p>
                            <p><strong>Diabetes:</strong> ${user.diabetes || 'No'}</p>
                            <p><strong>Last Updated:</strong> ${user.health_updated_at || 'Never'}</p>
                        </div>
                    </div>
                `;
                
                // Add blood donation forms section
                userDetailsHTML += `
                    <hr>
                    <h6 class="text-danger">ðŸ©¸ Blood Donation Forms (${bloodForms.length})</h6>
                `;
                
                if (bloodForms.length > 0) {
                    // Display the first form directly in the modal
                    const form = bloodForms[0];
                    const formData = form.form_data;
                    
                    userDetailsHTML += `
                        <div class="card mt-3">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0">ðŸ“‹ Donation Form Details</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Form Information</h6>
                                        <p><strong>Request ID:</strong> ${form.request_id || 'N/A'}</p>
                                        <p><strong>Submitted At:</strong> ${form.submitted_at || 'N/A'}</p>
                                        <p><strong>Status:</strong> <span class="badge bg-${form.status === 'submitted' ? 'success' : 'warning'}">${form.status || 'Unknown'}</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Personal Details</h6>
                                        <p><strong>Full Name:</strong> ${formData.personal_info?.full_name || 'N/A'}</p>
                                        <p><strong>Date of Birth:</strong> ${formData.personal_info?.date_of_birth || 'N/A'}</p>
                                        <p><strong>Gender:</strong> ${formData.personal_info?.gender || 'N/A'}</p>
                                        <p><strong>Weight:</strong> ${formData.personal_info?.weight || 'N/A'} kg</p>
                                        <p><strong>Contact No:</strong> ${formData.personal_info?.contact_no || 'N/A'}</p>
                                        <p><strong>ID Proof:</strong> ${formData.personal_info?.id_proof || 'N/A'}</p>
                                    </div>
                                </div>
                                <hr>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-success">General Eligibility</h6>
                                        <p><strong>Recent Donation:</strong> ${formData.general_eligibility?.recent_donation || 'N/A'}</p>
                                        <p><strong>Weight > 50kg:</strong> ${formData.general_eligibility?.weight_50kg || 'N/A'}</p>
                                        <p><strong>Proper Meal:</strong> ${formData.general_eligibility?.proper_meal || 'N/A'}</p>
                                        <p><strong>Sleep Hours:</strong> ${formData.general_eligibility?.sleep_hours || 'N/A'}</p>
                                        <p><strong>Healthy Today:</strong> ${formData.general_eligibility?.healthy_today || 'N/A'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-warning">Medical History</h6>
                                        <p><strong>Chronic Illness:</strong> ${formData.medical_history?.chronic_illness || 'N/A'}</p>
                                        <p><strong>Major Surgery:</strong> ${formData.medical_history?.major_surgery || 'N/A'}</p>
                                        <p><strong>Blood Transfusion:</strong> ${formData.medical_history?.blood_transfusion || 'N/A'}</p>
                                        <p><strong>Current Medicines:</strong> ${formData.medical_history?.current_medicines || 'N/A'}</p>
                                        <p><strong>Infectious Diseases:</strong> ${formData.medical_history?.infectious_diseases || 'N/A'}</p>
                                    </div>
                                </div>
                                <hr>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-danger">Infectious Disease & Risk</h6>
                                        <p><strong>Jaundice:</strong> ${formData.infectious_disease_risk?.jaundice || 'N/A'}</p>
                                        <p><strong>HIV Positive:</strong> ${formData.infectious_disease_risk?.hiv_positive || 'N/A'}</p>
                                        <p><strong>Tattoo/Piercing:</strong> ${formData.infectious_disease_risk?.tattoo_piercing || 'N/A'}</p>
                                        <p><strong>Dental Surgery:</strong> ${formData.infectious_disease_risk?.dental_surgery || 'N/A'}</p>
                                        <p><strong>IV Drugs:</strong> ${formData.infectious_disease_risk?.iv_drugs || 'N/A'}</p>
                                        <p><strong>High Risk Group:</strong> ${formData.infectious_disease_risk?.high_risk_group || 'N/A'}</p>
                                        <p><strong>Unprotected Sex:</strong> ${formData.infectious_disease_risk?.unprotected_sex || 'N/A'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-info">Travel & Lifestyle</h6>
                                        <p><strong>Malaria Travel:</strong> ${formData.travel_lifestyle?.malaria_travel || 'N/A'}</p>
                                        <p><strong>International Travel:</strong> ${formData.travel_lifestyle?.international_travel || 'N/A'}</p>
                                        <p><strong>Alcohol Consumption:</strong> ${formData.travel_lifestyle?.alcohol_consumption || 'N/A'}</p>
                                        <p><strong>Smoking:</strong> ${formData.travel_lifestyle?.smoking || 'N/A'}</p>
                                    </div>
                                </div>
                                <hr>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-dark">Current Health Condition</h6>
                                        <p><strong>Current Symptoms:</strong> ${formData.current_health?.current_symptoms || 'N/A'}</p>
                                        <p><strong>Recent Vaccination:</strong> ${formData.current_health?.recent_vaccination || 'N/A'}</p>
                                        <p><strong>Recent Antibiotics:</strong> ${formData.current_health?.recent_antibiotics || 'N/A'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Consent & Declaration</h6>
                                        <p><strong>Donor Signature:</strong> ${formData.consent_declaration?.donor_signature || 'N/A'}</p>
                                        <p><strong>Signature Date:</strong> ${formData.consent_declaration?.signature_date || 'N/A'}</p>
                                        <p><strong>Consent Terms:</strong> ${formData.consent_declaration?.consent_terms ? 'Agreed' : 'Not agreed'}</p>
                                    </div>
                                </div>
                                
                                <hr>
                                <div class="row">
                                    <div class="col-md-12">
                                        <h6 class="text-warning">Staff Checks (To be filled by staff)</h6>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <p><strong>Hemoglobin:</strong> ${formData.staff_checks?.hemoglobin || 'Not checked'} g/dL</p>
                                            </div>
                                            <div class="col-md-3">
                                                <p><strong>Blood Pressure:</strong> ${formData.staff_checks?.blood_pressure || 'Not checked'} mmHg</p>
                                            </div>
                                            <div class="col-md-3">
                                                <p><strong>Pulse:</strong> ${formData.staff_checks?.pulse || 'Not checked'} /min</p>
                                            </div>
                                            <div class="col-md-3">
                                                <p><strong>Temperature:</strong> ${formData.staff_checks?.temperature || 'Not checked'} Â°C</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    userDetailsHTML += `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No blood donation forms submitted yet.
                        </div>
                    `;
                }
                
                document.getElementById('userDetails').innerHTML = userDetailsHTML;
                const modal = new bootstrap.Modal(document.getElementById('userModal'));
                modal.show();

                // Wire Donation Form button: always visible; handle missing form gracefully
                const openBtn = document.getElementById('openDonationFormBtn');
                openBtn.onclick = () => {
                    if (currentFirstFormId) {
                        window.open(`/admin/donation_form/${currentFirstFormId}`, '_blank');
                    } else {
                        // Simple toast/alert when no form exists
                        alert('No donation form submitted yet for this user.');
                    }
                };
            } else {
                alert('Error loading user details: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading user details');
        });
}

function sendMessage(userId) {
    alert('Send message functionality for user: ' + userId);
}


function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        fetch(`/admin/user/${userId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting user');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user');
        });
    }
}

// Search functionality
document.getElementById('searchInput').addEventListener('keyup', function() {
    const searchText = this.value.toLowerCase();
    const tableRows = document.querySelectorAll('tbody tr');
    
    tableRows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchText) ? '' : 'none';
    });
});
</script>
{% endblock %} 